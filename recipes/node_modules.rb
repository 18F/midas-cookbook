
package_dir = "#{node.midas.user_home}/sails-postgresql"

user node.midas.user do
  supports :manage_home => true
  home node.midas.user_home
end

git package_dir do
  repository node.sails.postgresql_repo
  revision node.sails.postgresql_git_revision
  action :sync
  user 'midas'
end

nodejs_npm 'sails-postgresql' do
  path package_dir
  json true
  user node.midas.user
  group node.midas.group
end

execute 'link sails-postgresql' do
  command <<-HERE
    sudo npm link
  HERE
  cwd package_dir
end

# install global packages
npm_packages = ['grunt-cli']

npm_packages.each do |np|
  nodejs_npm np
end

# install midas dependencies locally
nodejs_npm 'midas' do
  path node.midas.deploy_dir
  json true
  user node.midas.user
  group node.midas.group
  options ['--production']
end

execute 'install sails-postgresql' do
  command <<-HERE
    npm link sails-postgresql
  HERE
  cwd node.midas.deploy_dir
  user node.midas.user
end
